services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    ports:
      - "3000:3000"
    volumes:
      # Mount source code for live reloading
      - .:/app
      # Named volume for node_modules to avoid clobbering
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      # Override for Docker networking - use service name instead of localhost
      - OPENCODE_SERVER_URL=http://opencode:4096
      - REDIS_URL=redis://redis:6379
    env_file:
      - .env
    depends_on:
      - opencode
      - redis
    networks:
      - sprintagen-network

  opencode:
    build:
      context: .
      dockerfile: Dockerfile.opencode
    ports:
      - "4096:4096"
    environment:
      # Cerebras API key for the AI provider
      - CEREBRAS_API_KEY=${CEREBRAS_API_KEY}
    volumes:
      # Mount local repository for analysis (volume mount instead of cloning)
      - ./opencode_repo:/workspace/repo:ro

      # Persist opencode config and auth tokens
      - opencode_data:/root/.opencode
    networks:
      - sprintagen-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sprintagen-network

volumes:
  node_modules:
  opencode_data:
  redis_data:

networks:
  sprintagen-network:
    driver: bridge
